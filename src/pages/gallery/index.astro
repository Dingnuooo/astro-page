---
import { Image, getImage } from 'astro:assets'
import PageLayout from '@/layouts/CommonPage.astro'
import json from './_info.json'
import DynamicSignature from '@/components/DynamicSignature.astro'

const galleryFiles = import.meta.glob('./_assets/*.{jpg,jpeg,png,webp}', { eager: true })

const images = await Promise.all(
  Object.entries(galleryFiles)
    .sort((a, b) => a[0].localeCompare(b[0]))
    .map(async ([path, mod]) => {
      const src = (mod as any).default;
      const filename = path.split('/').pop();
      const metadata = filename ? (json as any)[filename] : undefined;
      
      const highRes = await getImage({ 
        src, 
        format: 'webp', 
        quality: 100
        // width: src.width > 2000 ? 2000 : src.width
      });

      return {
        src,
        metadata,
        highResSrc: highRes.src
      }
    })
)
---

<PageLayout title='Gallery' comment wide>
  <p class='text-muted-foreground'>
    一些日常影像的合集。（摄影学习中，任何喜欢和建议欢迎评论交流）
    <!-- <span class="text-foreground/55">点击图片右上角查看图片描述，单击图片查看大图。</span> -->
  </p>
  <div class='flex justify-end mt-8 md:mt--5 mb-8'>
    <DynamicSignature width='15rem' />
  </div>
  <div class='gallery-container'>
    {
      images.map((item, index) => (
        <div
          class='gallery-item group'
          style={{
            '--ratio': item.src.width / item.src.height
          }}
        >
          <Image
            src={item.src}
            alt=''
            height={480}
            class='gallery-img'
            data-zoom-src={item.highResSrc}
            loading={index < 8 ? 'eager' : 'lazy'}
            fetchpriority={index < 8 ? 'high' : 'auto'}
            format='webp'
            quality={50}
            widths={[480, 960]}
          />
          
          <button class='info-btn absolute top-2 right-2 z-20 opacity-60 hover:opacity-100 transition-opacity duration-300 ease-in-out p-1.5 rounded-full bg-black/20 text-white backdrop-blur-md border border-white/20 hover:bg-black/40'>
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
          </button>

          <div class='gallery-overlay hidden absolute inset-0 z-30 flex-col items-center justify-center text-center p-4 bg-black/40 backdrop-blur-md opacity-0 transition-opacity duration-300'>
             <p class='text-white text-lg font-bold mb-2 whitespace-pre-line'>{item.metadata?.title || 'No title'}</p>
             <p class='text-white/80 text-xs font-mono whitespace-pre-line'>{item.metadata?.subtitle || ''}</p>
          </div>
        </div>
      ))
    }
  </div>
  
  <div id='zoom-loader' class='fixed z-[20000] hidden pointer-events-none rounded-full bg-black/50 p-2'>
    <div class='loader-spinner'></div>
  </div>

  <script is:inline type='module'>
    import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm'
    
    // Move loader to body
    const loader = document.getElementById('zoom-loader')
    if (loader && loader.parentElement !== document.body) {
      document.body.appendChild(loader)
    }

    // Init with empty set
    const zoom = mediumZoom({ background: 'rgba(0,0,0,0.8)' })

    // Helper function for overlay control
    const toggleOverlay = (overlay, show) => {
      if (show) {
        overlay.classList.remove('hidden')
        overlay.classList.add('flex')
        overlay.offsetHeight
        overlay.classList.remove('opacity-0')
        overlay.classList.add('opacity-100')
      } else {
        overlay.classList.remove('opacity-100')
        overlay.classList.add('opacity-0')
        setTimeout(() => {
          overlay.classList.add('hidden')
          overlay.classList.remove('flex')
        }, 300)
      }
    }

    const hideOverlay = (overlay) => toggleOverlay(overlay, false)
    const isOverlayVisible = (overlay) => !overlay.classList.contains('hidden')

    // Logic for Info Button
    document.querySelectorAll('.info-btn').forEach(btn => {
       btn.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          const galleryItem = btn.closest('.gallery-item')
          const overlay = galleryItem?.querySelector('.gallery-overlay')
          if (overlay) {
            toggleOverlay(overlay, !isOverlayVisible(overlay))
          }
       })
    })

    // Logic for Overlay Click
    document.querySelectorAll('.gallery-overlay').forEach(overlay => {
       overlay.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          hideOverlay(overlay)
       })
    })

    // Logic for auto hide info on mouse leave
    document.querySelectorAll('.gallery-item').forEach(item => {
       item.addEventListener('mouseleave', () => {
          const overlay = item.querySelector('.gallery-overlay')
          if (overlay && isOverlayVisible(overlay)) {
            hideOverlay(overlay)
          }
       })
    })

    // Logic for Image zoom
    document.querySelectorAll('.gallery-img').forEach(img => {
      img.addEventListener('click', async (e) => {
        const galleryItem = img.closest('.gallery-item')
        const overlay = galleryItem?.querySelector('.gallery-overlay')
        
        // Don't zoom if overlay is visible
        if (overlay && isOverlayVisible(overlay)) return

        e.preventDefault()
        e.stopPropagation()

        const hdSrc = img.getAttribute('data-zoom-src')
        if (!hdSrc) return

        // loader ring positioning
        const rect = img.getBoundingClientRect()
        const loaderSize = 48
        loader.style.position = 'absolute'
        loader.style.top = `${rect.top + window.scrollY + rect.height / 2 - loaderSize / 2}px`
        loader.style.left = `${rect.left + window.scrollX + rect.width / 2 - loaderSize / 2}px`
        loader.classList.remove('hidden')

        // Load high-res image
        const temp = new Image()
        
        const openZoom = () => {
          loader.classList.add('hidden')
          zoom.attach(img)
          zoom.open({ target: img })
        }

        temp.onload = openZoom;
        
        temp.onerror = () => {
          console.error('unable to load high-res image:', hdSrc)
          // Fallback: still open zoom with current image
          openZoom()
        }

        temp.src = hdSrc
      })
    })

    // Detach on close to reset state for next click
    zoom.on('closed', ({ target }) => {
      zoom.detach(target)
    })
  </script>
</PageLayout>

<style>
  .loader-spinner {
    width: 32px;
    height: 32px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .gallery-container {
    --row-height: 240px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .gallery-item {
    height: var(--row-height);
    flex-basis: calc(var(--row-height) * var(--ratio));
    flex-grow: var(--ratio);
    position: relative;
    overflow: hidden;
    border-radius: 4px;
    min-width: 190px;
  }

  @media (max-width: 768px) {
    .gallery-container {
      --row-height: 150px;
    }
    .gallery-item {
      min-width: 0px;
    }
  }

  .gallery-img {
    height: 100%;
    width: 100%;
    object-fit: cover;
    vertical-align: bottom;
    cursor: zoom-in;
  }
  
  :global(.gallery-img.medium-zoom-image--opened) {
    object-fit: contain;
    z-index: 9999;
  }

  /* Last row alignment */
  .gallery-container::after {
    content: '';
    flex-grow: 999999999;
  }
</style>
